#! /bin/sh

VERSION=4.2

# small safety test
if [ ! -f module/pgmodule.c ]
then
	echo "Hmmm.  Are you sure you are in the right directory?"
	exit 1
fi

if [ -f BETA ]
then
	VERSION=$VERSION-pre`date +"%y%m%d"`
	PACKAGE=pygresql.pkg-beta
	SYMLINK=PyGreSQL-beta.tgz
else
	PACKAGE=pygresql.pkg
	SYMLINK=PyGreSQL.tgz
fi

# Package up as a source tarball in the distribution directory.
# Note that this does essentially the same as "python setup.py sdist",
# except this also makes the docs and bundles them as source and html.

DISTDIR=/u/pyg/files
TD=PyGreSQL-$VERSION
TF=$DISTDIR/$TD.tgz

MODFILES="module/pg.py module/pgdb.py module/pgmodule.c
          module/pgfs.h module/pgtypes.h
          module/setup.py module/setup.cfg"
DOCFILES="docs/Makefile docs/make.bat docs/*.rst
          docs/_build/html/*.html docs/_build/html/*.js
          docs/_build/html/_static"
TESTFILES="module/tests/*.py"
TUTFILES="tutorial/*.py"

echo "Making source tarball..."

./mkdocs

rm -rf $TD
mkdir $TD
mkdir -p $TD/docs/_static
mkdir $TD/tests
mkdir $TD/tutorial
cp $MODFILES $TD
cp -r $DOCFILES $TD/docs
cp $TESTFILES $TD/tests
cp $TUTFILES $TD/tutorial
tar -cvzf $TF $TD
chmod 644 $TF
rm -rf $TD
rm -f $DISTDIR/$SYMLINK
ln -s $TD.tgz $DISTDIR/$SYMLINK

echo "$TF has been built"

